<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title></title>
	<style>
		.flex-container {
			display: flex;
			flex-direction: row;
			width: 400px;
			height: 400px;
			background-color: lightgrey;
		}

		.flex-item {
			background-color: cornflowerblue;
			width: 100px;
			height: 100px;
			margin: 10px;
		}

		.container {
			position: relative;
			width: 100%;
			margin-top: 5px;
		}

		.image {
			opacity: 1;
			display: block;
			width: 100%;
			height: auto;
			transition: .5s ease;
			backface-visibility: hidden;
		}

		.middle {
			transition: .5s ease;
			opacity: 0;
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			-ms-transform: translate(-50%, -50%);
			text-align: center;
			width: 100%;
		}

		.container:hover .image {
			opacity: 0.3;
			filter: brightness(50%);
		}

		.container:hover .middle {
			opacity: 1;
		}

		.text {
			background-color: #4CAF50;
			color: white;
			font-size: 16px;
			padding: 5px 10px;
		}

		/* The Modal (background) */
		.modal {
			display: none; /* Hidden by default */
			position: fixed; /* Stay in place */
			z-index: 1; /* Sit on top */
			padding-top: 100px; /* Location of the box */
			left: 0;
			top: 0;
			width: 100%; /* Full width */
			height: 100%; /* Full height */
			overflow: auto; /* Enable scroll if needed */
			background-color: rgb(0,0,0); /* Fallback color */
			background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
		}

		/* Modal Content */
		.modal-content {
			background-color: #fefefe;
			margin: auto;
			padding: 20px;
			border: 1px solid #888;
			width: 80%;
		}

		/* The Close Button */
		.close {
			color: #aaaaaa;
			float: right;
			font-size: 28px;
			font-weight: bold;
		}

			.close:hover,
			.close:focus {
				color: #000;
				text-decoration: none;
				cursor: pointer;
			}
	</style>
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<!--<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC73I53JXmKD6NKj-CZKJCGuW4C7uNwfhY&libraries=places"></script>-->
	<script src="https://maps.google.com/maps/api/js?key=AIzaSyC73I53JXmKD6NKj-CZKJCGuW4C7uNwfhY&libraries=placeses,visualization,drawing,geometry,places"></script>
	<script src="https://code.angularjs.org/1.3.15/angular.js"></script>
	<!--<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>-->
	<script src="https://rawgit.com/allenhwkim/angularjs-google-maps/master/build/scripts/ng-map.js"></script>
	<!--<script src="/ng-map.min.js"></script>-->
	<!--https://ngmap.github.io/#/!custom-marker-two-way-binding.html -->

	<script>

		var app = angular.module('myApp', ['ngMap']);

		app.directive('fileModel', ['$parse', function ($parse) {
			return {
				restrict: 'A',
				link: function (scope, element, attrs) {
					var model = $parse(attrs.fileModel);
					var modelSetter = model.assign;

					element.bind('change', function () {
						scope.$apply(function () {
							modelSetter(scope, element[0].files[0]);
						});
					});
				}
			};
		}]);

		app.service('fileUpload', ['$http', function ($http) {
			this.uploadFileToUrl = function (file, uploadUrl) {
				var fd = new FormData();
				fd.append('file', file);

				$http.post(uploadUrl, fd, {
					transformRequest: angular.identity,
					headers: { 'Content-Type': undefined }
				}).success(function () {

				}).error(function () {
				});
			}
		}]);

		var mapService = function () {

			var map;

			this.initMap = function () {
				map = new google.maps.Map(document.getElementById('map'), {
					center: { lat: -34.397, lng: 150.644 },
					zoom: 12
				});


				// Try HTML5 geolocation.
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(function (position) {
						var pos = {
							lat: position.coords.latitude,
							lng: position.coords.longitude
						};

						var request = {
							location: pos,
							radius: '50000',
							types: ['restaurant'],
							name: 'McDonald'
						};

						var infoWindow = new google.maps.InfoWindow;

						var service = new google.maps.places.PlacesService(map);
						var mapIdList = [];
						service.nearbySearch(request, function (results, status) {
							if (status == google.maps.places.PlacesServiceStatus.OK) {
								for (var i = 0; i < results.length; i++) {
									var place = results[i];
									// If the request succeeds, draw the place location on
									// the map as a marker, and register an event to handle a
									// click on the marker.
									//var marker = new google.maps.Marker({
									//	map: map,
									//	position: place.geometry.location
									//});

									mapIdList.push(place.id);

									infoWindow = new google.maps.InfoWindow;
									infoWindow.setPosition(place.geometry.location);
									infoWindow.setContent('<p id="' + place.id + '">' + place.name + '</p>'/*Show a small scoller of all available toys*/);
									infoWindow.open(map);
								}
							}
							mapIdList.forEach(function (m) {
								var infoWId = "#" + m;
								$(infoWId).click(function () {
									//use original 'this'
									this.testfunc();
								});
							});
							map.setCenter(pos);
						});
					}, function () {
						this.handleLocationError(true, infoWindow, map.getCenter());
					});
				} else {
					// Browser doesn't support Geolocation
					this.handleLocationError(false, infoWindow, map.getCenter());
				}
			},

				this.testfunc = function () {
					alert("cool here");
				},

				this.handleLocationError = function (browserHasGeolocation, infoWindow, pos) {
					infoWindow.setPosition(pos);
					infoWindow.setContent(browserHasGeolocation ?
						'Error: The Geolocation service failed.' :
						'Error: Your browser doesn\'t support geolocation.');
					infoWindow.open(map);
				},

				this.getMcDList = function () {

					// Try HTML5 geolocation.
					if (navigator.geolocation) {
						navigator.geolocation.getCurrentPosition(function (position) {
							var pos = {
								lat: position.coords.latitude,
								lng: position.coords.longitude
							};

							var request = {
								location: pos,
								radius: '50000',
								types: ['restaurant'],
								name: 'McDonald'
							};
							var mapIdList = [];

							var service = new google.maps.places.PlacesService(map);

							service.nearbySearch(request, function (results, status) {
								if (status == google.maps.places.PlacesServiceStatus.OK) {
									for (var i = 0; i < results.length; i++) {
										var place = results[i];

										//vm.positions1 = [
										//	{ pos: [40.11, -75.21], name: 1 }, { pos: [40.22, -75.10], name: 2 },
										//	{ pos: [40.33, -74.99], name: 3 }, { pos: [40.44, -74.88], name: 4 },
										//	{ pos: [40.55, -74.77], name: 5 }, { pos: [40.66, -74.66], name: 6 }];

										mapIdList.push(
											{
												id: place.id,

											}
										);
									}
								}
							});
						});
					}
				}

		};

		app.service('mapService', mapService);

		app.controller('myCtrl', function ($scope, fileUpload, NgMap, mapService) {

			mapService.getMcDList();

			var vm = this;
			NgMap.getMap().then(function (map) {
				console.log('map', map);
				vm.map = map;
			});

			vm.shops = [
				{ id: 'foo', name: 'FOO SHOP', position: [41, -87] },
				{ id: 'bar', name: 'BAR SHOP', position: [42, -86] }
			];
			vm.shop = vm.shops[0];

			$scope.uploadFile = function () {
				var file = $scope.myFile;

				console.log('file is ');
				console.dir(file);

				var uploadUrl = "/fileUpload";
				fileUpload.uploadFileToUrl(file, uploadUrl);
			};

			var addToyModal = document.getElementById('dialog-form');

			$scope.uploadNewToy = function () {
				var data = "data";
			}

			$scope.openAddToyDialog = function () {
				//dialog.dialog("open");
				addToyModal.style.display = "block";
			};

			$scope.closeAddToyDialog = function () {
				addToyModal.style.display = "none";
			}

			$scope.addToyForm = {
				toyName: "",
				fileData: ""
			}

			$scope.imgSRC = [{ id: "1", src: "toy1.jpg" }, { id: "2", src: "toy2.jpg" }];
			$scope.removeImg = function (id) {
				var _id = id;
				/*send REST call to background*/
			}
			$scope.testfunc = function () {
				alert("here");
			}
			$scope.initMap = function () {
				mapService.initMap();
			}
		});

	</script>
</head>
<body ng-app="myApp">
	<div class="flex-container" ng-controller="myCtrl" style="width: 1200px;">
		<div class="flex-item" style="width: 65%;">
			Map
			<div class="flex-container" id="map" style="width: auto;"></div>

			<ng-map default-style="true" center="current-location" zoom="8">
				<marker id='currLocation' position="current-location"></marker>
				<info-window id="foo-iw" visible="true" ng-repeat="shop in vm.shops">
					<div ng-non-bindable="">
						id: {{vm.shop.id}}<br />
						name: {{vm.shop.name}}<br />
						Position 1: {{vm.shop.position}}<br />
						Position 2: {{anchor.getPosition()}}<br />
						Position 3: {{vm.map.markers[vm.shop.id].getPosition()}}<br />
						<a href="#" ng-click="vm.clicked()">Click Here</a>
					</div>
				</info-window>
			</ng-map>

		</div>
		<div class="flex-item" style="width: 30%;">
			<div class="flex-container" style="width: 100%;flex-direction: row; height: auto;">
				<div style="width: 50%; margin-right: 5px;">
					<div class="container" ng-repeat="isrc in imgSRC">
						<img ng-src="{{isrc.src}}" alt="Avatar" class="image" style="width:120px">
						<div class="middle">
							<div>
								<img src="Like.png" ng-click="like(isrc.id)" style="display:inline-block;width:30px; height:30px" />
								<img src="NotLike.png" ng-click="notLike(isrc.id)" style="display:inline-block;width:30px; height:30px" />
							</div>
							<img src="delete1Btn.png" ng-click="removeImg(isrc.id)" style="width:40px; height:40px" />
						</div>
					</div>
				</div>
				<div style="width: 50%; margin-right: 5px;">
					<div class="container" ng-repeat="isrc in imgSRC">
						<img ng-src="{{isrc.src}}" alt="Avatar" class="image" style="width:120px">
						<div class="middle">
							<div>
								<img src="Like.png" ng-click="like(isrc.id)" style="display:inline-block;width:30px; height:30px" />
								<img src="NotLike.png" ng-click="notLike(isrc.id)" style="display:inline-block;width:30px; height:30px" />
							</div>
							<img src="delete1Btn.png" ng-click="removeImg(isrc.id)" style="width:40px; height:40px" />
						</div>
					</div>
				</div>
			</div>
			<div class="flex-container" style="margin-top: 10px; width: auto; height:auto">
				<button id="add-toy" ng-click="openAddToyDialog()" class="ui-button ui-widget ui-corner-all" style="width: 100%;">Add Toy</button>
			</div>
		</div>
		<div id="dialog-form" class="modal" title="Create new user" style="height:auto">
			<div class="modal-content">
				<span class="close" ng-click="closeAddToyDialog()">&times;</span>
				<form>
					<fieldset style="border:none">
						<label for="name">Description</label>
						<input type="text" name="name" id="name" ng-model="addToyForm.toyName" placeholder="Name of the toy..." value="Jane Smith" class="text ui-widget-content ui-corner-all">
						<label for="pict">Upload Picture</label>
						<!--<input name="pict" id="pict" ng-model="addToyForm.fileData" type="file" value="Add Picture..." />-->
						<!-- Allow form submission with keyboard without duplicating the dialog button -->

						<input type="file" file-model="myFile" />
						<button ng-click="uploadFile()">upload me</button>

						<input type="submit" tabindex="-1" value="Add Toy">
					</fieldset>
				</form>
			</div>
		</div>

	</div>
</body>

</html>